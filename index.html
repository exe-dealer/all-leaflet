<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>all leaflet</title>
  <style type="text/css">
    html, body, #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }
  </style>
  <link href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" rel="stylesheet" />
  <link href="https://raw.githubusercontent.com/exe-dealer/leaflet.measure/master/leaflet.measure/leaflet.measure.css" rel="stylesheet" />
  <script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet-src.js"></script>
  <script src="https://raw.githubusercontent.com/exe-dealer/leaflet.measure/master/leaflet.measure/leaflet.measure.js"></script>

</head>
<body>
  <div id="map"></div>
  

  <script type="text/javascript">
    var basemapsConf = [
      {
        "name"         : "bing",
        "tileUrlTmpl"  : "http://ak.dynamic.t{s}.tiles.virtualearth.net/comp/ch/{quadkey}?mkt=ru-ru&it=G,VE,BX,L,LA&shading=hill&og=23&n=z",
        "isElliptical" : false,
        "subdomains"   : "01234567",
        "minZoom"      : 1,
        "maxZoom"      : 21
      },
      {
        "name"         : "bing bird's eye",
        "tileUrlTmpl"  : "http://ak.t{s}.tiles.virtualearth.net/tiles/cmd/svhybrid?a={quadkey}&g=0",
        "isElliptical" : false,
        "subdomains"   : "01234567",
        "minZoom"      : 1,
        "maxZoom"      : 17
      },
      {
        "name"         : "bing imagery",
        "tileUrlTmpl"  : "http://ak.dynamic.t{s}.tiles.virtualearth.net/comp/ch/{quadkey}?mkt=ru-ru&it=A,G,L&shading=hill&og=23&n=z",
        "isElliptical" : false,
        "subdomains"   : "01234567",
        "minZoom"      : 1,
        "maxZoom"      : 19
      },
      {
        "name"         : "esri_imagery_world_2d",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/ESRI_Imagery_World_2D/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "esri_streetmap_world_2d",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "google",
        "tileUrlTmpl"  : "http://mts{s}.google.com/vt/hl=ru&x={x}&y={y}&z={z}",
        "isElliptical" : false,
        "subdomains"   : "0123",
        "minZoom"      : 0,
        "maxZoom"      : 22
      },
      {
        "name"         : "google satellite",
        "tileUrlTmpl"  : "http://khms{s}.google.ru/kh/v=136&x={x}&y={y}&z={z}",
        "isElliptical" : false,
        "subdomains"   : "0123",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "mapbox github",
        "tileUrlTmpl"  : "https://{s}.tiles.mapbox.com/v3/github.map-xgq2svrz/{z}/{x}/{y}.png",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "natgeo_world_map",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "ocean_basemap",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "open street map",
        "tileUrlTmpl"  : "http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 19
      },
      {
        "name"         : "usa_topo_maps",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "world_imagery",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "world_physical_map",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/World_Physical_Map/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "world_shaded_relief",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/World_Shaded_Relief/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "world_street_map",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "world_terrain_base",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "world_topo_map",
        "tileUrlTmpl"  : "http://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",
        "isElliptical" : false,
        "subdomains"   : "abc",
        "minZoom"      : 0,
        "maxZoom"      : 23
      },
      {
        "name"         : "2gis",
        "tileUrlTmpl"  : "http://tile{s}.maps.2gis.com/tiles?x={x}&y={y}&z={z}",
        "isElliptical" : false,
        "subdomains"   : "0123",
        "minZoom"      : 0,
        "maxZoom"      : 18
      },
      {
        "name"         : "yandex",
        "tileUrlTmpl"  : "http://vec0{s}.maps.yandex.net/tiles?l=map&x={x}&y={y}&z={z}",
        "isElliptical" : true,
        "subdomains"   : "01234",
        "minZoom"      : 0,
        "maxZoom"      : 18
      },
      {
        "name"         : "yandex public map",
        "tileUrlTmpl"  : "http://0{s}.pvec.maps.yandex.net?l=pmap&x={x}&y={y}&z={z}",
        "isElliptical" : true,
        "subdomains"   : "01234",
        "minZoom"      : 0,
        "maxZoom"      : 20
      },
      {
        "name"         : "yandex satellite",
        "tileUrlTmpl"  : "http://sat0{s}.maps.yandex.net/tiles?l=sat&x={x}&y={y}&z={z}",
        "isElliptical" : true,
        "subdomains"   : "01234",
        "minZoom"      : 0,
        "maxZoom"      : 19
      }
    ];


    var almatyLatLng = L.latLng(43.260535, 76.945493);
    var moscowAltuf = L.latLng(55.89832002666662, 37.586631774902344);

    var map = L.map('map', {
      measureControl: true,
      center: moscowAltuf,
      zoom: 14
    });

    map.on('baselayerchange', function (e) {
      var center = map.getCenter();
      var zoom = map.getZoom();
      map.options.crs = e.layer.options.isElliptical ? L.CRS.EPSG3395 : L.CRS.EPSG3857;
      map._resetView(center, zoom, false, false);
    });

    // http://msdn.microsoft.com/en-us/library/bb259689.aspx
    function quadkey(zyx) {
      var result = '';
      for (var i = zyx.z; i > 0; i--) {
        var digit = 0;
        var mask = 1 << (i - 1);
        if ((zyx.x & mask) != 0) {
          digit++;
        }
        if ((zyx.y & mask) != 0) {
          digit++;
          digit++;
        }
        result += digit;
      }
      return result;
    }

    var layersCtl = L.control.layers(null, null, {
      collapsed: false
    });
    basemapsConf.forEach(function (conf, i) {
      var layerOptions = L.Util.extend({ quadkey: quadkey }, conf);
      var layer = L.tileLayer(conf.tileUrlTmpl, layerOptions);
      layersCtl.addBaseLayer(layer, conf.name);
      if (i === 0) {
        layer.addTo(map);
      }
    });
    layersCtl.addTo(map);


    function pointUrl(latlng) {
      return location.origin +
        location.pathname +
        '?lat=' + latlng.lat +
        '&lng=' + latlng.lng;
    }

    map.on('click', function (e) {
      L.popup()
        .setContent(pointUrl(e.latlng))
        .setLatLng(e.latlng)
        .openOn(map);
    });

    query = location.search;
    var latMatch = query.match('lat=(\\d+\\.?\\d*)');
    var lngMatch = query.match('lng=(\\d+\\.?\\d*)');
    if (latMatch && lngMatch) {
      var latlng = L.latLng(latMatch[1], lngMatch[1]);
      L.marker(latlng)
        .addTo(map)
        .bindPopup(pointUrl(latlng))
        .openPopup();
    }

  </script>
</body>
</html>
